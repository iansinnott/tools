#!/bin/bash

if [[ $# = 0 ]] ; then
  ls | xargs -n 1 ${BASH_SOURCE[0]}
  exit
fi

if [[ $1 =~ \. ]]; then
  [[ -n "$2" ]] && base="$2" || base=$( echo $1 | sed -n 's/\..*$//p' )
  base_url=$1
  extra=
else
  base=$1
  base_url=$base.bandcamp.com
  extra=music
fi
shift

echo "♫ $base ♫"
[ -e $base ] || mkdir $base
cd $base

for i in $(curl -s https://$base_url/$extra | grep -Po '(?<=album\/)[^?'"'"'"]*' | sort | uniq ); do
  if [[ ! -e $i ]]; then 
    mkdir $i
    cd $i
    url=https://$base_url/album/$i
    echo "  ⇩ $url"
    youtube-dl -- "$url"
    cd ..
  else
    count=$( ls $i | wc -l )
    [[ "$count" = "0" ]] && count="- ---" || count="✓ $count"
    echo "  $count $i"
  fi
done
