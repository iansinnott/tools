#!/bin/bash

if [[ $# = 0 ]] ; then
  ls | xargs -n 1 ${BASH_SOURCE[0]}
  exit
fi

if [[ $1 =~ \. ]]; then
  if [[ -n "$2" ]]; then 
    base="$2" 
    domain=$1
  else 
    base=$( echo $1 | sed -n 's/\..*$//p' )
  fi
  base_url=$1
  extra=
else
  base=$1
  base_url=$base.bandcamp.com
  extra=music
fi
shift

echo "♫ $base ♫"
[[ -e $base ]] || mkdir $base

if [[ -e $base/domain ]]; then
  base_url=$(< $base/domain )
  echo " ! using $base_url" 
elif [[ -n "$domain" ]]; then
  echo $base_url > $base/domain
fi

starting_point=$PWD
cd $base

for i in $(curl -s https://$base_url/$extra | grep -Po '(?<=album\/)[^?'"'"'"]*' | sort | uniq ); do
  if [[ ! -e $i ]]; then 
    cd $starting_point
    mkdir $i
    cd $i
    url=https://$base_url/album/$i
    echo "  ⇩ $url"
    youtube-dl -- "$url"
  else
    count=$( ls $i | wc -l )
    [[ "$count" = "0" ]] && count="- ---" || count="✓ $count"
    echo "  $count $i"
  fi
done
