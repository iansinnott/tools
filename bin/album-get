#!/bin/bash

if [[ $# = 0 ]] ; then
  ls | xargs -n 1 ${BASH_SOURCE[0]}
  exit
fi

if [[ $1 =~ \. ]]; then
  if [[ -n "$2" ]]; then 
    base="$2" 
    domain=$1
  else 
    base=$( echo $1 | sed -n 's/\..*$//p' )
  fi
  base_url=$1
  extra=
else
  base=$1
  base_url=$base.bandcamp.com
  extra=music
fi
shift

echo "♫ $base ♫"
[[ -e $base ]] || mkdir $base

if [[ -e $base/domain ]]; then
  base_url=$(< $base/domain )
  echo " ! using $base_url" 
elif [[ -n "$domain" ]]; then
  echo $base_url > $base/domain
fi

cd $base
starting_point=$PWD

for full in $(curl -s https://$base_url/$extra |  grep -Po '(?<=")[\w:\/\.]+(?<=album\/)[^?'"'"'"]*' | sort | uniq ); do
  i=$(basename $full)
  place=$starting_point/$i
  [[ -e $place ]] || mkdir $place
  count=$( ls $place | wc -l )
  if [[ "$count" = "0" ]]; then
    cd $place
    echo ">> $place"
    if [[ $full =~ : ]]; then
      url=$full
    else
      url=https://$base_url/album/$i
    fi
    echo "  ⇩ $url"
    youtube-dl --reject-title "\.wav" -- "$url"
  else
    count="✓ $count"
    echo "  $count $i"
  fi
done
